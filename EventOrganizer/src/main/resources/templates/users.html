<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Felhasználók és Regisztráció</title>
    <link rel="stylesheet" href="css/user_styles.css">
    <link rel="stylesheet" href="css/navStyles.css">
    <link rel="stylesheet" href="css/modal.css">
</head>
<body>
<nav class="nav">
    <a href="/calendar">
        <svg class="navSvg" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><path d="M113.854 22.323h-9.667v-2.677a7.25 7.25 0 0 0-14.5 0v2.677H38.313v-2.677a7.25 7.25 0 0 0-14.5 0v2.677h-9.667a1.75 1.75 0 0 0-1.75 1.75v89.781a1.751 1.751 0 0 0 1.75 1.75h99.708a1.751 1.751 0 0 0 1.75-1.75V24.073a1.75 1.75 0 0 0-1.75-1.75zm-20.667-2.677a3.75 3.75 0 0 1 7.5 0V28.5a3.75 3.75 0 0 1-7.5 0zm-65.874 0a3.75 3.75 0 0 1 7.5 0V28.5a3.75 3.75 0 0 1-7.5 0zm-3.5 6.177V28.5a7.25 7.25 0 0 0 14.5 0v-2.677h51.374V28.5a7.25 7.25 0 0 0 14.5 0v-2.677h7.913V44.2H15.9V25.823zM15.9 112.1V47.7h96.2v64.4z"/><path d="M40.2 56h-8.721a1.749 1.749 0 0 0-1.75 1.75v8.719a1.749 1.749 0 0 0 1.75 1.75H40.2a1.749 1.749 0 0 0 1.75-1.75V57.75A1.749 1.749 0 0 0 40.2 56zm-1.75 8.719h-5.221V59.5h5.218zM58.972 56h-8.719a1.75 1.75 0 0 0-1.75 1.75v8.719a1.75 1.75 0 0 0 1.75 1.75h8.719a1.75 1.75 0 0 0 1.75-1.75V57.75a1.75 1.75 0 0 0-1.75-1.75zm-1.75 8.719H52V59.5h5.219zM77.747 56h-8.719a1.75 1.75 0 0 0-1.75 1.75v8.719a1.75 1.75 0 0 0 1.75 1.75h8.719a1.749 1.749 0 0 0 1.75-1.75V57.75a1.749 1.749 0 0 0-1.75-1.75zM76 64.719h-5.222V59.5H76zM96.521 56H87.8a1.749 1.749 0 0 0-1.75 1.75v8.719a1.749 1.749 0 0 0 1.75 1.75h8.718a1.749 1.749 0 0 0 1.75-1.75V57.75A1.749 1.749 0 0 0 96.521 56zm-1.75 8.719h-5.218V59.5h5.218zM40.2 74h-8.721a1.749 1.749 0 0 0-1.75 1.75v8.719a1.749 1.749 0 0 0 1.75 1.75H40.2a1.749 1.749 0 0 0 1.75-1.75V75.75A1.749 1.749 0 0 0 40.2 74zm-1.75 8.719h-5.221V77.5h5.218zM58.972 74h-8.719a1.75 1.75 0 0 0-1.75 1.75v8.719a1.75 1.75 0 0 0 1.75 1.75h8.719a1.75 1.75 0 0 0 1.75-1.75V75.75a1.75 1.75 0 0 0-1.75-1.75zm-1.75 8.719H52V77.5h5.219zM77.747 74h-8.719a1.75 1.75 0 0 0-1.75 1.75v8.719a1.75 1.75 0 0 0 1.75 1.75h8.719a1.749 1.749 0 0 0 1.75-1.75V75.75a1.749 1.749 0 0 0-1.75-1.75zM76 82.719h-5.222V77.5H76zM96.521 74H87.8a1.749 1.749 0 0 0-1.75 1.75v8.719a1.749 1.749 0 0 0 1.75 1.75h8.718a1.749 1.749 0 0 0 1.75-1.75V75.75A1.749 1.749 0 0 0 96.521 74zm-1.75 8.719h-5.218V77.5h5.218zM40.2 92h-8.721a1.749 1.749 0 0 0-1.75 1.75v8.719a1.749 1.749 0 0 0 1.75 1.75H40.2a1.749 1.749 0 0 0 1.75-1.75V93.75A1.749 1.749 0 0 0 40.2 92zm-1.75 8.719h-5.221V95.5h5.218zM58.972 92h-8.719a1.75 1.75 0 0 0-1.75 1.75v8.719a1.75 1.75 0 0 0 1.75 1.75h8.719a1.75 1.75 0 0 0 1.75-1.75V93.75a1.75 1.75 0 0 0-1.75-1.75zm-1.75 8.719H52V95.5h5.219zM77.747 92h-8.719a1.75 1.75 0 0 0-1.75 1.75v8.719a1.75 1.75 0 0 0 1.75 1.75h8.719a1.749 1.749 0 0 0 1.75-1.75V93.75a1.749 1.749 0 0 0-1.75-1.75zM76 100.719h-5.222V95.5H76zM96.521 92H87.8a1.749 1.749 0 0 0-1.75 1.75v8.719a1.749 1.749 0 0 0 1.75 1.75h8.718a1.749 1.749 0 0 0 1.75-1.75V93.75A1.749 1.749 0 0 0 96.521 92zm-1.75 8.719h-5.218V95.5h5.218z"/> </svg>
    </a>
    <a href="/users">
        <svg class="navSvg" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><rect x="0" fill="none" width="20" height="20"/><g><path d="M10 9.25c-2.27 0-2.73-3.44-2.73-3.44C7 4.02 7.82 2 9.97 2c2.16 0 2.98 2.02 2.71 3.81 0 0-.41 3.44-2.68 3.44zm0 2.57L12.72 10c2.39 0 4.52 2.33 4.52 4.53v2.49s-3.65 1.13-7.24 1.13c-3.65 0-7.24-1.13-7.24-1.13v-2.49c0-2.25 1.94-4.48 4.47-4.48z"/></g> </svg>
    </a>
    <a href="/logout">
        <svg class="navSvg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M5 3h16v4h-2V5H5v14h14v-2h2v4H3V3h2zm16 8h-2V9h-2V7h-2v2h2v2H7v2h10v2h-2v2h2v-2h2v-2h2v-2z" fill="#000000"/>
        </svg>
    </a>
</nav>

<div class="container">
    <div style="width: 50%">
    <input type="text" id="myInput" onkeyup="myFunction()" placeholder="Search for names..">
    <table class="users-list" id="myTable">
        <tr class="header">
            <th style="width:60%;">Név</th>
            <th style="width:40%;">Szerep</th>
        </tr>
        <div th:each="user : ${users}">
        <tr>
            <td th:text="${user.getUserName()}"></td>
            <td><button class="detailsButton" th:attr="data-user-id=${user.getId()}" th:id="${user.getId()}">Részletek</button></td>
        </tr>
        </div>
    </table>
    </div>
    <div style="position: sticky; top: 0" class="registration-panel">
        <h2>Új felhasználó regisztrálása</h2>
        <form th:object="${UserDTO}" id="registrationForm" th:action="@{/users}" method="post">
            <input type="text" th:field="*{userName}" placeholder="Username" required>
            <input type="email" th:field="*{email}" placeholder="Email" required>
            <input type="password" th:field="*{password}" placeholder="Password" required>
            <button type="submit">Regisztrálás</button>
        </form>
    </div>
</div>
<div id="userModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <h2>Felhasználói adatok</h2>

        <!-- Form for updating user -->
        <form id="userUpdateForm">
            <label for="userNameModal">Felhasználónév:</label>
            <input type="text" id="userNameModal" name="userName" required>

            <label for="emailModal">Email:</label>
            <input type="email" id="emailModal" name="email" required>

            <label for="roleModal">Szerepkör:</label>
            <select id="roleModal" name="role" required>
                <option value="admin">admin</option>
                <option value="user">user</option>
            </select>

            <input type="hidden" id="userIdModal" name="userId">

            <button type="submit">Frissítés</button>
        </form>
    </div>
</div>

<script src="js/userscripts.js"></script>
<script>
    var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    var modal = document.getElementById("userModal");
    function openDetails() {
        var id = this.getAttribute("data-user-id");

        fetch(`/users/${id}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Hiba történt a felhasználó adatainak lekérésekor.");
                }
                return response.json();
            })
            .then(user => {
                document.getElementById("userNameModal").value = user.userName;
                document.getElementById("emailModal").value = user.email;
                document.getElementById('roleModal').selectedIndex = user.role === "admin" ? 0 : 1;
                document.getElementById('userIdModal').value = user.id
                modal.style.display = "block";
            })
            .catch(error => {
                console.error("Error fetching user data:", error);
            });
    }


    var buttons = document.getElementsByClassName("detailsButton");

    for (var i = 0; i < buttons.length; i++) {
        buttons[i].addEventListener('click', openDetails);
    }

    function closeModal(){
        modal.style.display = "none"
    }

    document.getElementById("closeModal").addEventListener('click', closeModal)

    document.getElementById("userUpdateForm").addEventListener("submit", function(event) {
        event.preventDefault();

        var userId = document.getElementById("userIdModal").value;
        var userName = document.getElementById("userNameModal").value;
        var email = document.getElementById("emailModal").value;
        var role = document.getElementById("roleModal").value;

        var updatedUserData = {
            userName: userName,
            email: email,
            role: role
        };

        fetch(`/users/${userId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken  // Add the CSRF token to the headers
            },
            body: JSON.stringify(updatedUserData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Hiba történt a felhasználó frissítésekor.");
                }
                return response.json();
            })
            .then(updatedUser => {
                alert('Felhasználó sikeresen frissítve!');
                modal.style.display = "none";
                location.reload();
            })
            .catch(error => {
                console.error("Error updating user:", error);
            });
    });
</script>

</body>
</html>
